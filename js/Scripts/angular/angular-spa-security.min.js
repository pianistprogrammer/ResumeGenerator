angular.module("security",[]).constant("security.urls",{site:"/",manage:"/manage",join:"/api/account/register",login:"/token",logout:"/api/account/logout",forgotPassword:"/api/account/forgotpassword",resetPassword:"/api/account/resetpassword",confirmEmail:"/api/account/confirmEmail",userInfo:"/api/account/userInfo",changePassword:"/api/account/changePassword",externalLogins:"/api/account/externalLogins",manageInfo:"/api/account/manageInfo",registerExternal:"/api/account/registerExternal",addExternalLogin:"/api/account/addExternalLogin",removeLogin:"/api/account/removeLogin"}).factory("security.api",["$http","security.urls",function(a,b){var c={"Content-Type":"application/x-www-form-urlencoded"},d=function(a){var b=function(a){var d,e,f,g,c="";return angular.forEach(a,function(a,h){if(a instanceof Array)for(g=0;g<a.length;++g)d=a[g],e=h+"["+g+"]",f={},f[e]=d,c+=b(f)+"&";else a instanceof Object?angular.forEach(a,function(a,d){e=h+"["+d+"]",f={},f[e]=a,c+=b(f)+"&"}):void 0!==a&&null!==a&&(c+=encodeURIComponent(h)+"="+encodeURIComponent(a)+"&")}),c.length?c.substr(0,c.length-1):c};return angular.isObject(a)&&"[object File]"!==String(a)?b(a):a},e={getUserInfo:function(c){return a({url:b.userInfo,method:"GET",headers:{Authorization:"Bearer "+c}})},login:function(e){return a({method:"POST",url:b.login,data:d(e),headers:c})},logout:function(){return a({method:"POST",url:b.logout})},register:function(c){return a({method:"POST",url:b.join,data:c})},forgotPassword:function(c){return a({method:"POST",url:b.forgotPassword,data:c})},resetPassword:function(c){return a({method:"POST",url:b.resetPassword,data:c})},confirmEmail:function(c){return a({method:"GET",url:b.confirmEmail+"?code="+encodeURIComponent(c.code)+"&userId="+encodeURIComponent(c.userId)})},changePassword:function(c){return a({method:"POST",url:b.changePassword,data:c})},getExternalLogins:function(){return a({method:"GET",url:b.externalLogins+"?returnUrl="+encodeURIComponent(b.site)+"&generateState=true",isArray:!0})},manageInfo:function(){return a({method:"GET",url:b.manageInfo+"?returnUrl="+encodeURIComponent(b.site)+"&generateState=false"})},registerExternal:function(c,d){return a({method:"POST",url:b.registerExternal,data:d,headers:{Authorization:"Bearer "+c}})},addExternalLogin:function(c,d){return a({method:"POST",url:b.addExternalLogin,data:{externalAccessToken:d},headers:{Authorization:"Bearer "+c}})},removeLogin:function(c){return a({method:"POST",url:b.removeLogin,data:c})}};return e}]).provider("security",["security.urls",function(a){var b=this;b.registerThenLogin=!0,b.usePopups=!1,b.urls={login:"/login",registerExternal:"/registerExternal",postLogout:"/login",home:"/"},b.apiUrls=a,b.events={login:null,logout:null,register:null,reloadUser:null,closeOAuthWindow:null},b.$get=["security.api","$q","$http","$location","$timeout",function(a,c,d,e,f){var g=null,h=function(a){var c,d,e,f,g,h,i,b={};if(null===a)return b;c=a.split("&");for(var j=0;j<c.length;j++)d=c[j],e=d.indexOf("="),-1===e?(f=d,g=null):(f=d.substr(0,e),g=d.substr(e+1)),h=decodeURIComponent(f),i=decodeURIComponent(g),b[h]=i;return b},i=function(a,b){return a&&("clear"==a?(localStorage.removeItem("accessToken"),sessionStorage.removeItem("accessToken"),delete d.defaults.headers.common.Authorization):(b?localStorage.accessToken=a:sessionStorage.accessToken=a,d.defaults.headers.common.Authorization="Bearer "+a)),sessionStorage.accessToken||localStorage.accessToken},j=function(a){return"clear"==a?(delete localStorage.associating,void 0):(a&&(localStorage.associating=a),localStorage.associating)},k=function(a){return"clear"==a?(delete localStorage.redirectTarget,void 0):(a&&(localStorage.redirectTarget=a),localStorage.redirectTarget)},l=function(d,f,g){var h=c.defer();return d.error?h.reject({message:d.error}):i()&&j()?(j("clear"),k("clear"),a.addExternalLogin(i(),d.access_token).success(function(){h.resolve()})):a.getUserInfo(d.access_token).success(function(a){a.hasRegistered?(i(d.access_token,g),n.user=a,n.redirectAuthenticated(k()||b.urls.home),b.events.login&&b.events.login(n,a),h.resolve(n.user)):(n.externalUser=a,n.externalUser.access_token=d.access_token,n.externalUser.provider=f,null!=g&&(localStorage.rememberMe=g),e.path(b.urls.registerExternal),h.reject())}),h.promise},m=function(){if(-1!=e.path().indexOf("access_token")){var c=h(e.path().substring(1));if(window.opener)window.opener.external_data=c,window.close();else{var d=k();e.path(d||b.urls.home);var f=JSON.parse(localStorage.loginProvider),g=!1;localStorage.rememberMe&&(g=JSON.parse(localStorage.rememberMe),delete localStorage.rememberMe),delete localStorage.loginProvider,l(c,f,g)}}i()&&(i(i()),a.getUserInfo(i()).success(function(a){n.user=a,b.events.reloadUser&&b.events.reloadUser(n,a)})),a.getExternalLogins().success(function(a){n.externalLogins=a})},n=this;return n.user=null,n.externalUser=null,n.externalLogins=[],n.login=function(d){var e=c.defer();return d.grant_type="password",a.login(d).success(function(a){i(a.access_token,d.rememberMe),n.user=a,n.redirectAuthenticated(k()||b.urls.home),b.events.login&&b.events.login(n,a),e.resolve(n.user)}).error(function(a){e.reject(a)}),e.promise},n.loginWithExternal=function(a,d){var e=c.defer();if(b.usePopups){var h=window.open(a.url,"frame","resizeable,height=510,width=380");f.cancel(g),g=f(function i(){if(!h.closed)return g=f(i,500),void 0;if(b.events.closeOAuthWindow&&b.events.closeOAuthWindow(n,window.external_data),"undefined"==typeof window.external_data)return e.reject(),void 0;var c=window.external_data;delete window.external_data,e.resolve(l(c,a,d.rememberMe))},500)}else null!=d&&null!=d.rememberMe&&(localStorage.rememberMe=JSON.stringify(d.rememberMe)),localStorage.loginProvider=JSON.stringify(a),window.location.href=a.url;return e.promise},n.logout=function(){var d=c.defer();return a.logout().success(function(){n.user=null,i("clear"),k("clear"),b.events.logout&&b.events.logout(n),e.path(b.urls.postLogout),d.resolve()}).error(function(a){d.reject(a)}),d.promise},n.register=function(d){var e=c.defer();return a.register(d).success(function(){b.events.register&&b.events.register(n),b.registerThenLogin?n.login(d).then(function(a){e.resolve(a)},function(a){e.reject(a)}):e.resolve()}).error(function(a){e.reject(a)}),e.promise},n.registerExternal=function(){var b=c.defer();return n.externalUser?a.registerExternal(n.externalUser.access_token,n.externalUser).success(function(){b.resolve(n.loginWithExternal(n.externalUser.provider)),n.externalUser=null}).error(function(a){b.reject(a)}):b.reject(),b.promise},n.forgotPassword=function(b){var d=c.defer();return a.forgotPassword(b).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},n.resetPassword=function(b){var d=c.defer();return a.resetPassword(b).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},n.confirmEmail=function(b){var d=c.defer();return a.confirmEmail(b).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},n.mangeInfo=function(){var b=c.defer();return a.manageInfo().success(function(a){b.resolve(a)}).error(function(a){b.reject(a)}),b.promise},n.changePassword=function(b){var d=c.defer();return a.changePassword(b).success(function(){d.resolve()}).error(function(a){d.reject(a)}),d.promise},n.addExternalLogin=function(b,d){var e=c.defer();return a.addExternalLogin(b,d).success(function(){e.resolve()}).error(function(a){e.reject(a)}),e.promise},n.associateExternal=function(a,d){var e=c.defer();if(b.usePopups){var h=window.open(a.url,"frame","resizeable,height=510,width=380");f.cancel(g),g=f(function i(){if(!h.closed)return g=f(i,500),void 0;if(b.events.closeOAuthWindow&&b.events.closeOAuthWindow(n,window.external_data),"undefined"==typeof window.external_data)return e.reject(),void 0;var c=window.external_data;delete window.external_data,e.resolve(l(c,a,data.rememberMe))},500)}else localStorage.loginProvider=JSON.stringify(a),j(!0),k(d||"/"),window.location.href=a.url;return e.promise},n.removeLogin=function(b){var d=c.defer();return a.removeLogin(b).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},n.authenticate=function(){i()||(k()||k(e.path()),e.path(b.urls.login))},n.redirectAuthenticated=function(a){i()&&(k()&&k("clear"),e.path(a))},m(),n}]}]);